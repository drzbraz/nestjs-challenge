name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

services:
  mongo:
    image: mongo:6
    ports: [ "27017:27017" ]
    environment:
      MONGO_INITDB_DATABASE: records
    healthcheck:
      test: mongosh --eval 'db.runCommand("ping").ok' localhost:27017/test --quiet
      interval: 2s
      timeout: 3s
      retries: 5
    volumes: [ mongo_data:/data/db ]

volumes: { mongo_data: {} }

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Run e2e tests
        run: npm run test:e2e
